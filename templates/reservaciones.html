<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reserva tu Trajinera - Trajineras Barrón</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='css/reservaciones.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/header.css') }}">
    <link rel="stylesheet" href="{{ url_for('static', filename='css/footer.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css">
</head>

<body>
    {% include 'header.html' %}

    <!-- 1. HEADER CON PROGRESO -->
    <section class="reservation-header">
        <div class="container">
            <div class="reservation-title">
                <h1><i class="fas fa-ship"></i> Reserva tu Trajinera</h1>
                <p class="subtitle">Crea tu experiencia perfecta en Xochimilco</p>
            </div>

            <div class="progress-bar">
                <div class="progress-step active" id="step1-indicator">
                    <div class="step-number">1</div>
                    <div class="step-info">
                        <div class="step-title">Elige paquete</div>
                        <div class="step-desc">Selecciona fecha y paquete</div>
                    </div>
                </div>

                <div class="progress-step" id="step2-indicator">
                    <div class="step-number">2</div>
                    <div class="step-info">
                        <div class="step-title">Personaliza</div>
                        <div class="step-desc">Agrega extras y catering</div>
                    </div>
                </div>

                <div class="progress-step" id="step3-indicator">
                    <div class="step-number">3</div>
                    <div class="step-info">
                        <div class="step-title">Tus datos</div>
                        <div class="step-desc">Información de contacto</div>
                    </div>
                </div>

                <div class="progress-step" id="step4-indicator">
                    <div class="step-number">4</div>
                    <div class="step-info">
                        <div class="step-title">Paga</div>
                        <div class="step-desc">Confirma tu reserva</div>
                    </div>
                </div>

                <div class="progress-line">
                    <div class="progress-fill" id="progress-fill"></div>
                </div>
            </div>
        </div>
    </section>

    <!-- SECCIÓN PRINCIPAL DE RESERVA -->
    <div class="reservation-container">
        <div class="container">
            <div class="reservation-wizard">
                <!-- PASO 1: ELECCIÓN DE PAQUETE Y FECHA -->
                <div class="reservation-step active" id="step1">
                    <div class="step-header">
                        <h2><i class="far fa-calendar-alt"></i> Elige tu Paquete y Fecha</h2>
                        <p>Selecciona la fecha, hora y paquete para tu experiencia</p>
                    </div>

                    <div class="step-content">
                        <div class="date-time-selector">
                            <div class="selector-card">
                                <h3><i class="fas fa-calendar-day"></i> Fecha del Evento</h3>
                                <div class="date-picker-container">
                                    <input type="text" id="datepicker" placeholder="Selecciona una fecha"
                                        data-min-date="{{ today }}">
                                    <i class="fas fa-calendar-alt"></i>
                                </div>
                                <div class="availability-status" id="availability-status">
                                    <i class="fas fa-info-circle"></i>
                                    <span>Selecciona una fecha para ver disponibilidad</span>
                                </div>
                            </div>

                            <div class="selector-card">
                                <h3><i class="far fa-clock"></i> Hora del Recorrido</h3>
                                <div class="time-slots" id="time-slots" style="max-height: 300px; overflow-y: auto;">
                                    <!-- Horarios cada 30 minutos desde las 9am hasta las 8pm -->
                                    <!-- Se generará dinámicamente con JS, pero aquí está la estructura -->
                                </div>
                            </div>

                            <div class="selector-card">
                                <h3><i class="fas fa-users"></i> Número de Personas</h3>
                                <div class="people-selector">
                                    <button class="people-btn minus" onclick="adjustPeople(-1)">
                                        <i class="fas fa-minus"></i>
                                    </button>
                                    <div class="people-count">
                                        <input type="number" id="people-count" value="10" min="1" max="20" readonly>
                                        <div class="people-label">personas</div>
                                    </div>
                                    <button class="people-btn plus" onclick="adjustPeople(1)">
                                        <i class="fas fa-plus"></i>
                                    </button>
                                </div>
                                <div class="capacity-info">
                                    <i class="fas fa-info-circle"></i>
                                    <span>Capacidad máxima: 20 personas por trajinera</span>
                                </div>
                            </div>
                        </div>

                        <div class="packages-selection">
                            <h3><i class="fas fa-map-marked-alt"></i> Selecciona tu Paquete de Recorrido</h3>
                            <div class="packages-grid" id="packages-grid">
                                {% for key, package in packages.items() %}
                                <div class="package-card-reservation" data-package="{{ key }}">
                                    <div class="package-header">
                                        <div class="package-icon">
                                            <i class="fas fa-ship"></i>
                                        </div>
                                        <h4>{{ package.name }}</h4>
                                        <div class="package-tag">
                                            <span class="tag popular">{{ package.duration }}</span>
                                        </div>
                                    </div>

                                    <div class="package-body">
                                        <div class="package-price-dynamic">
                                            <div class="price-final">
                                                <span class="amount">${{ package.price }}</span>
                                                <span class="currency">MXN</span>
                                            </div>
                                        </div>

                                        <ul class="package-includes">
                                            {% for item in package.includes[:4] %}
                                            <li><i class="fas fa-check"></i> {{ item }}</li>
                                            {% endfor %}
                                        </ul>
                                    </div>

                                    <div class="package-footer">
                                        <button class="btn btn-primary btn-block btn-select"
                                            onclick="selectPackage('{{ key }}', '{{ package.name }}', {{ package.price }})">
                                            <i class="fas fa-check"></i> Seleccionar
                                        </button>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                        </div>

                        <div class="step-actions">
                            <button class="btn btn-primary btn-next" onclick="nextStep()" id="step1-next" disabled>
                                Continuar a Extras <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- PASO 2: EXTRAS PERSONALIZADOS -->
                <div class="reservation-step" id="step2">
                    <div class="step-header">
                        <h2><i class="fas fa-utensils"></i> Extras Personalizados</h2>
                        <p>Agrega antojitos, música y decoración a tu experiencia</p>
                    </div>

                    <div class="step-content">
                        <div class="personalization-container">
                            <div class="personalization-main">

                                <!-- SECCIÓN: ANTOJITOS MEXICANOS -->
                                <div class="personalization-section">
                                    <h3><i class="fas fa-drumstick-bite"></i> Antojitos Mexicanos</h3>
                                    <div class="extras-grid">
                                        {% for platillo in comida.platillos %}
                                        <div class="extra-item">
                                            <div class="extra-info">
                                                <h5>{{ platillo.name }}</h5>
                                                <p>{{ platillo.description[:60] }}...</p>
                                                <div class="extra-price">${{ platillo.price }} MXN</div>
                                            </div>
                                            <div class="extra-controls">
                                                <div class="quantity-selector">
                                                    <button class="qty-btn minus"
                                                        onclick="adjustItem('{{ platillo.id }}', -1, {{ platillo.price }}, '{{ platillo.name }}')">-</button>
                                                    <input type="number" class="qty-input" id="qty-{{ platillo.id }}"
                                                        value="0" readonly>
                                                    <button class="qty-btn plus"
                                                        onclick="adjustItem('{{ platillo.id }}', 1, {{ platillo.price }}, '{{ platillo.name }}')">+</button>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>

                                <!-- SECCIÓN: ENTRETENIMIENTO -->
                                <div class="personalization-section">
                                    <h3><i class="fas fa-music"></i> Entretenimiento</h3>
                                    <div class="extras-grid">
                                        {% for servicio in servicios_extra.musica %}
                                        <div class="extra-item">
                                            <div class="extra-info">
                                                <h5>{{ servicio.nombre }}</h5>
                                                <p>{{ servicio.duracion }}</p>
                                                <div class="extra-price">${{ servicio.precio }} MXN</div>
                                            </div>
                                            <div class="extra-controls">
                                                <div class="toggle-switch">
                                                    <input type="checkbox" id="extra-{{ loop.index }}"
                                                        onchange="toggleExtraItem('{{ servicio.nombre }}', {{ servicio.precio }}, this.checked)">
                                                    <label for="extra-{{ loop.index }}"></label>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>

                                <!-- SECCIÓN: DECORACIÓN -->
                                <div class="personalization-section">
                                    <h3><i class="fas fa-palette"></i> Decoración</h3>
                                    <div class="extras-grid">
                                        {% for servicio in servicios_extra.decoracion %}
                                        <div class="extra-item">
                                            <div class="extra-info">
                                                <h5>{{ servicio.nombre }}</h5>
                                                <p>{{ servicio.descripcion }}</p>
                                                <div class="extra-price">${{ servicio.precio }} MXN</div>
                                            </div>
                                            <div class="extra-controls">
                                                <div class="toggle-switch">
                                                    <input type="checkbox" id="deco-{{ loop.index }}"
                                                        onchange="toggleExtraItem('{{ servicio.nombre }}', {{ servicio.precio }}, this.checked)">
                                                    <label for="deco-{{ loop.index }}"></label>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>

                                <!-- SECCIÓN: SERVICIOS EXTRA (FOTOGRAFÍA, ETC) -->
                                <div class="personalization-section">
                                    <h3><i class="fas fa-camera"></i> Servicios Extra</h3>
                                    <div class="extras-grid">
                                        {% for servicio in servicios_extra.fotografia %}
                                        <div class="extra-item">
                                            <div class="extra-info">
                                                <h5>{{ servicio.nombre }}</h5>
                                                <p>{{ servicio.duracion }}</p>
                                                <div class="extra-price">${{ servicio.precio }} MXN</div>
                                            </div>
                                            <div class="extra-controls">
                                                <div class="toggle-switch">
                                                    <input type="checkbox" id="foto-{{ loop.index }}"
                                                        onchange="toggleExtraItem('{{ servicio.nombre }}', {{ servicio.precio }}, this.checked)">
                                                    <label for="foto-{{ loop.index }}"></label>
                                                </div>
                                            </div>
                                        </div>
                                        {% endfor %}
                                    </div>
                                </div>

                            </div>

                            <!-- RESUMEN LATERAL -->
                            <div class="personalization-sidebar">
                                <div class="summary-card" id="sticky-summary">
                                    <h3><i class="fas fa-receipt"></i> Resumen</h3>
                                    <div class="summary-details">
                                        <p><strong>Paquete:</strong> <span id="summary-package-name">Ninguno</span></p>
                                        <p><strong>Fecha:</strong> <span id="summary-date-display">-</span></p>
                                        <p><strong>Hora:</strong> <span id="summary-time-display">-</span></p>
                                        <hr>
                                        <ul id="summary-items-list" class="summary-list">
                                            <!-- Items agregados -->
                                        </ul>
                                        <hr>
                                        <div class="total-display">
                                            <span>Total:</span>
                                            <span id="grand-total">$0 MXN</span>
                                        </div>
                                        <div class="deposit-display">
                                            <span>Apartado (30%):</span>
                                            <span id="deposit-total">$0 MXN</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <div class="step-actions">
                            <button class="btn btn-outline" onclick="prevStep()">
                                <i class="fas fa-arrow-left"></i> Regresar
                            </button>
                            <button class="btn btn-primary btn-next" onclick="nextStep()">
                                Continuar a Datos <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- PASO 3: DATOS -->
                <div class="reservation-step" id="step3">
                    <div class="step-header">
                        <h2><i class="fas fa-user"></i> Tus Datos</h2>
                        <p>Información para confirmar tu reserva</p>
                    </div>
                    <div class="step-content">
                        <div class="contact-form-container">
                            <form id="contact-form">
                                <div class="form-row">
                                    <div class="form-group">
                                        <label>Nombre completo</label>
                                        <input type="text" id="client-name" required>
                                    </div>
                                    <div class="form-group">
                                        <label>Teléfono / WhatsApp</label>
                                        <input type="tel" id="client-phone" required>
                                    </div>
                                </div>
                                <div class="form-group">
                                    <label>Correo electrónico</label>
                                    <input type="email" id="client-email" required>
                                </div>
                                <div class="form-group">
                                    <label>Comentarios adicionales</label>
                                    <textarea id="client-notes" rows="3"></textarea>
                                </div>
                            </form>
                        </div>
                        <div class="step-actions">
                            <button class="btn btn-outline" onclick="prevStep()">
                                <i class="fas fa-arrow-left"></i> Regresar
                            </button>
                            <button class="btn btn-primary btn-next" onclick="validateAndNext()">
                                Ir a Pagar <i class="fas fa-arrow-right"></i>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- PASO 4: PAGO -->
                <div class="reservation-step" id="step4">
                    <div class="step-header">
                        <h2><i class="fas fa-money-bill-wave"></i> Realizar Pago</h2>
                        <p>Completa el depósito para asegurar tu fecha</p>
                    </div>

                    <div class="step-content">
                        <div class="payment-info-container">
                            <div class="payment-amount-box">
                                <h3>Monto a pagar ahora (30% de anticipo)</h3>
                                <div class="final-amount" id="payment-amount-display">$0.00 MXN</div>
                                <p class="total-ref">Total del servicio: <span id="payment-total-ref">$0.00</span></p>
                            </div>

                            <div class="transfer-details-card">
                                <h3><i class="fas fa-university"></i> Datos para Transferencia</h3>
                                <div class="bank-info">
                                    <div class="bank-row">
                                        <span class="label">Banco:</span>
                                        <span class="value">BBVA Bancomer</span>
                                    </div>
                                    <div class="bank-row">
                                        <span class="label">Beneficiario:</span>
                                        <span class="value">Trajineras Barrón</span>
                                    </div>
                                    <div class="bank-row">
                                        <span class="label">CLABE:</span>
                                        <span class="value u-select-all">012 180 01234567890 1</span>
                                        <button class="btn-copy" onclick="copyToClipboard('012180012345678901')"><i
                                                class="far fa-copy"></i></button>
                                    </div>
                                    <div class="bank-row">
                                        <span class="label">Concepto:</span>
                                        <span class="value">Reserva <span id="concept-name">TuNombre</span></span>
                                    </div>
                                </div>

                                <div class="alert-box">
                                    <i class="fas fa-exclamation-circle"></i>
                                    <p>Una vez realizada la transferencia, envía el comprobante por WhatsApp al
                                        <strong>+52 55 6009 4568</strong> para confirmar tu reserva inmediatamente.</p>
                                </div>
                            </div>

                            <div class="action-buttons-final">
                                <a href="https://wa.me/525560094568" target="_blank" class="btn btn-whatsapp-large"
                                    id="btn-confirm-whatsapp">
                                    <i class="fab fa-whatsapp"></i> Enviar Comprobante
                                </a>
                            </div>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    {% include 'footer.html' %}

    <script src="https://cdn.jsdelivr.net/npm/flatpickr"></script>
    <script src="https://cdn.jsdelivr.net/npm/flatpickr/dist/l10n/es.js"></script>
    <script>
        // Lógica de la aplicación de reservas
        let currentStep = 1;
        let reservationData = {
            date: null,
            time: null,
            people: 10,
            package: null,
            packageName: '',
            packagePrice: 0,
            extras: {},
            total: 0
        };

        document.addEventListener('DOMContentLoaded', function () {
            // Inicializar calendario
            flatpickr("#datepicker", {
                locale: "es",
                minDate: "today",
                dateFormat: "Y-m-d",
                onChange: function (selectedDates, dateStr) {
                    reservationData.date = dateStr;
                    document.getElementById('summary-date-display').textContent = dateStr;
                    checkStep1();
                }
            });

            // Generar horarios cada 30 min
            const timeSlotsContainer = document.getElementById('time-slots');
            const startHour = 9; // 9 AM
            const endHour = 20; // 8 PM

            for (let h = startHour; h <= endHour; h++) {
                // Hora en punto
                createTimeSlot(h, 0, timeSlotsContainer);
                // Media hora (si no es la última hora límite exacta)
                if (h < endHour) {
                    createTimeSlot(h, 30, timeSlotsContainer);
                }
            }
        });

        function createTimeSlot(hour, minutes, container) {
            const timeString = `${hour}:${minutes === 0 ? '00' : minutes}`;
            const displayTime = formatTime(hour, minutes);

            const slot = document.createElement('div');
            slot.className = 'time-slot';
            slot.innerHTML = `<div class="slot-time">${displayTime}</div><div class="slot-status available">Disponible</div>`;
            slot.onclick = function () {
                document.querySelectorAll('.time-slot').forEach(s => s.classList.remove('selected'));
                slot.classList.add('selected');
                reservationData.time = timeString;
                document.getElementById('summary-time-display').textContent = displayTime;
                checkStep1();
            };
            container.appendChild(slot);
        }

        function formatTime(h, m) {
            const period = h >= 12 ? 'PM' : 'AM';
            const h12 = h > 12 ? h - 12 : (h === 0 ? 12 : h);
            const mStr = m === 0 ? '00' : m;
            return `${h12}:${mStr} ${period}`;
        }

        function adjustPeople(delta) {
            let newVal = parseInt(document.getElementById('people-count').value) + delta;
            if (newVal >= 1 && newVal <= 20) {
                document.getElementById('people-count').value = newVal;
                reservationData.people = newVal;
            }
        }

        function selectPackage(key, name, price) {
            document.querySelectorAll('.package-card-reservation').forEach(c => c.classList.remove('selected'));
            const card = document.querySelector(`.package-card-reservation[data-package="${key}"]`);
            if (card) card.classList.add('selected');

            reservationData.package = key;
            reservationData.packageName = name;
            reservationData.packagePrice = price;

            document.getElementById('summary-package-name').textContent = name;
            updateTotals();
            checkStep1();
        }

        function checkStep1() {
            const btn = document.getElementById('step1-next');
            if (reservationData.date && reservationData.time && reservationData.package) {
                btn.disabled = false;
            } else {
                btn.disabled = true;
            }
        }

        // Funciones de navegación
        function nextStep() {
            document.getElementById(`step${currentStep}`).classList.remove('active');
            document.getElementById(`step${currentStep}-indicator`).classList.remove('active'); // Mantener anterior activo visualmente si se desea, o cambiar lógica

            currentStep++;
            document.getElementById(`step${currentStep}`).classList.add('active');
            document.getElementById(`step${currentStep}-indicator`).classList.add('active');

            // Actualizar barra de progreso
            const progress = ((currentStep - 1) / 3) * 100;
            document.getElementById('progress-fill').style.width = `${progress}%`;

            if (currentStep === 4) {
                // Cargar datos finales
                const total = calculateTotal();
                const deposit = total * 0.3;
                document.getElementById('payment-amount-display').textContent = `$${deposit.toLocaleString('es-MX', { minimumFractionDigits: 2 })} MXN`;
                document.getElementById('payment-total-ref').textContent = `$${total.toLocaleString('es-MX', { minimumFractionDigits: 2 })} MXN`;

                const clientName = document.getElementById('client-name').value || 'Cliente';
                const clientNameShort = clientName.split(' ')[0];
                document.getElementById('concept-name').textContent = clientNameShort;

                // Configurar enlace de WhatsApp
                const phone = "525560094568";
                const msg = `Hola, acabo de realizar una transferencia de $${deposit.toFixed(2)} para mi reserva de ${reservationData.packageName} el día ${reservationData.date} a las ${reservationData.time}. Adjunto mi comprobante.`;
                document.getElementById('btn-confirm-whatsapp').href = `https://wa.me/${phone}?text=${encodeURIComponent(msg)}`;
            }
        }

        function prevStep() {
            document.getElementById(`step${currentStep}`).classList.remove('active');
            document.getElementById(`step${currentStep}-indicator`).classList.remove('active');
            currentStep--;
            document.getElementById(`step${currentStep}`).classList.add('active');

            // Actualizar barra de progreso
            const progress = ((currentStep - 1) / 3) * 100;
            document.getElementById('progress-fill').style.width = `${progress}%`;
        }

        function validateAndNext() {
            const name = document.getElementById('client-name').value;
            const phone = document.getElementById('client-phone').value;
            const email = document.getElementById('client-email').value;

            if (!name || !phone || !email) {
                alert('Por favor completa todos los campos obligatorios');
                return;
            }
            nextStep();
        }

        // Lógica de extras
        function adjustItem(id, delta, price, name) {
            const input = document.getElementById(`qty-${id}`);
            let val = parseInt(input.value) + delta;
            if (val < 0) val = 0;
            input.value = val;

            if (val > 0) {
                reservationData.extras[id] = { type: 'qty', name: name, price: price, qty: val };
            } else {
                delete reservationData.extras[id];
            }
            updateTotals();
        }

        function toggleExtraItem(name, price, checked) {
            if (checked) {
                reservationData.extras[name] = { type: 'toggle', name: name, price: price, qty: 1 };
            } else {
                delete reservationData.extras[name];
            }
            updateTotals();
        }

        function updateTotals() {
            const list = document.getElementById('summary-items-list');
            list.innerHTML = '';

            let extrasTotal = 0;

            for (const key in reservationData.extras) {
                const item = reservationData.extras[key];
                const itemTotal = item.price * item.qty;
                extrasTotal += itemTotal;

                const li = document.createElement('li');
                li.innerHTML = `<span>${item.name} ${item.qty > 1 ? `x${item.qty}` : ''}</span> <span>$${itemTotal}</span>`;
                list.appendChild(li);
            }

            const grandTotal = reservationData.packagePrice + extrasTotal;
            const deposit = grandTotal * 0.3;

            document.getElementById('grand-total').textContent = `$${grandTotal.toLocaleString()} MXN`;
            document.getElementById('deposit-total').textContent = `$${deposit.toLocaleString()} MXN`;
        }

        function calculateTotal() {
            let extrasTotal = 0;
            for (const key in reservationData.extras) {
                const item = reservationData.extras[key];
                extrasTotal += item.price * item.qty;
            }
            return reservationData.packagePrice + extrasTotal;
        }

        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('Número de cuenta copiado');
            });
        }
    </script>
</body>

</html>